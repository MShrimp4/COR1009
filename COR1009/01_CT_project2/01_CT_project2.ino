/*Project By 1조
 * 2018-04-29
 * 빨간 맛
 */

void piano_on(int port,unsigned long time_delay);
void piano_off(int port,unsigned long time_delay);
void start_again(int unused1,unsigned long unused2);

bool ports_enable[15]; // 켜진 포트 지정
bool ports_disable[15]; // 꺼진 포트 지정
int count; // 실행하는 음악 데이터 위치
void (*func[3])(int,unsigned long) = {piano_on,piano_off,start_again};
/* 실행할 함수들
 * func[0] : 건반 켜기
 * func[1] : 건반 끄기
 * func[2] : 다시 시작
 */
#define mport 9
// 피에조 스피커 포트

typedef struct{ // 음악을 담는 구조체
  byte function_name;
 /* 시킬 명령
  * 0 : 건반 켜기
  * 1 : 건반 끄기
  * 2 : 다시 시작
  */
  byte port_num;
  /* 켤 LED 포트
   * # 주의 #
   * 2번 (다시 시작) 은 이 변수를 사용하지 않음
   */
  unsigned long length_in_float;
  /* 실행할 시간
   * # 주의 #
   * 2번 (다시 시작) 은 이 변수를 사용하지 않음
   */
  } musicData;
musicData notes[1012]={ {1,2,0},{0,69,1173384},{1,69,110493},{0,69,6844},{1,69,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,110493},{0,69,6844},{1,69,1002266},{0,69,288457},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,110493},{0,66,6844},{1,66,333436},{0,69,18578},{1,69,667851},{0,69,270856},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,110493},{0,69,6844},{1,69,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,110493},{0,69,6844},{1,69,1002266},{0,69,288457},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,110493},{0,66,6844},{1,66,333436},{0,69,18578},{1,69,667851},{0,69,270856},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,444908},{0,66,141783},{1,66,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,221965},{0,68,12711},{1,68,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,61,12711},{1,61,221965},{0,57,12711},{1,57,444908},{0,66,845814},{1,66,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,221965},{0,68,12711},{1,68,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,61,12711},{1,61,1336680},{0,66,188719},{1,66,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,221965},{0,68,12711},{1,68,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,61,12711},{1,61,221965},{0,57,12711},{1,57,890794},{0,57,282590},{1,57,110493},{0,57,6844},{1,57,110493},{0,57,6844},{1,57,444908},{0,59,24445},{1,59,221965},{0,61,12711},{1,61,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,59,12711},{1,59,221965},{0,57,12711},{1,57,890794},{0,64,517267},{1,64,444908},{0,69,24445},{1,69,890794},{0,64,751944},{1,64,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,64,24445},{1,64,1782566},{0,64,329525},{1,64,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,64,24445},{1,64,444908},{0,69,24445},{1,69,1336680},{0,64,306057},{1,64,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,64,24445},{1,64,667851},{0,69,36179},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,221965},{0,78,12711},{1,78,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,221965},{0,71,12711},{1,71,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,444908},{0,69,259122},{1,69,110493},{0,69,6844},{1,69,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,110493},{0,69,6844},{1,69,1002266},{0,69,288457},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,110493},{0,66,6844},{1,66,333436},{0,69,18578},{1,69,667851},{0,69,270856},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,110493},{0,64,0},{0,69,6844},{1,64,0},{1,69,110493},{0,66,0},{0,69,6844},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,110493},{0,64,0},{0,69,6844},{1,64,0},{1,69,1002266},{0,64,0},{0,69,288457},{1,64,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,110493},{0,62,0},{0,66,6844},{1,62,0},{1,66,333436},{0,64,0},{0,69,18578},{1,64,0},{1,69,667851},{0,64,0},{0,69,270856},{1,64,0},{1,69,221965},{0,62,0},{0,69,12711},{1,62,0},{1,69,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,66,0},{0,69,24445},{1,66,0},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,62,0},{0,71,12711},{1,62,0},{1,71,221965},{0,61,0},{0,73,12711},{1,61,0},{1,73,444908},{0,64,0},{0,71,24445},{1,64,0},{1,71,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,61,0},{0,69,24445},{1,61,0},{1,69,444908},{0,73,0},{0,81,24445},{1,73,0},{1,81,444908},{0,69,259122},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,66,12711},{1,66,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,64,12711},{1,64,221965},{0,73,12711},{1,73,444908},{0,69,259122},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,66,12711},{1,66,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,64,12711},{1,64,221965},{0,73,12711},{1,73,890794},{0,66,165251},{1,66,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,221965},{0,68,12711},{1,68,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,61,12711},{1,61,221965},{0,57,12711},{1,57,444908},{0,66,845814},{1,66,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,221965},{0,68,12711},{1,68,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,66,12711},{1,66,221965},{0,64,12711},{1,64,221965},{0,61,12711},{1,61,221965},{0,59,12711},{1,59,221965},{0,61,12711},{1,61,1336680},{0,62,0},{0,66,188719},{1,62,0},{1,66,110493},{0,61,0},{0,69,6844},{1,61,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,64,0},{0,68,12711},{1,64,0},{1,68,221965},{0,62,0},{0,66,12711},{1,62,0},{1,66,221965},{0,61,0},{0,64,12711},{1,61,0},{1,64,221965},{0,62,0},{0,66,12711},{1,62,0},{1,66,221965},{0,61,0},{0,64,12711},{1,61,0},{1,64,221965},{0,57,0},{0,61,12711},{1,57,0},{1,61,221965},{0,56,0},{0,59,12711},{1,56,0},{1,59,221965},{0,57,0},{0,61,12711},{1,57,0},{1,61,221965},{0,54,0},{0,57,12711},{1,54,0},{1,57,890794},{0,57,0},{0,69,282590},{1,57,0},{1,69,110493},{0,57,0},{0,69,6844},{1,57,0},{1,69,110493},{0,54,0},{0,57,6844},{1,54,0},{1,57,444908},{0,56,0},{0,59,24445},{1,56,0},{1,59,221965},{0,57,0},{0,61,12711},{1,57,0},{1,61,221965},{0,61,0},{0,66,12711},{1,61,0},{1,66,221965},{0,61,0},{0,64,12711},{1,61,0},{1,64,221965},{0,57,0},{0,61,12711},{1,57,0},{1,61,221965},{0,56,0},{0,59,12711},{1,56,0},{1,59,221965},{0,56,0},{0,59,12711},{1,56,0},{1,59,221965},{0,54,0},{0,57,12711},{1,54,0},{1,57,890794},{0,64,517267},{1,64,444908},{0,69,24445},{1,69,890794},{0,61,0},{0,64,751944},{1,61,0},{1,64,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,62,0},{0,69,12711},{1,62,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,66,0},{0,71,12711},{1,66,0},{1,71,221965},{0,69,0},{0,73,12711},{1,69,0},{1,73,444908},{0,61,0},{0,64,24445},{1,61,0},{1,64,1782566},{0,61,0},{0,64,329525},{1,61,0},{1,64,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,62,0},{0,69,12711},{1,62,0},{1,69,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,68,0},{0,71,12711},{1,68,0},{1,71,221965},{0,64,0},{0,73,12711},{1,64,0},{1,73,444908},{0,61,0},{0,64,24445},{1,61,0},{1,64,444908},{0,61,0},{0,69,24445},{1,61,0},{1,69,1336680},{0,61,0},{0,64,306057},{1,61,0},{1,64,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,68,0},{0,71,12711},{1,68,0},{1,71,221965},{0,64,0},{0,73,12711},{1,64,0},{1,73,444908},{0,61,0},{0,64,24445},{1,61,0},{1,64,667851},{0,69,36179},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,221965},{0,78,12711},{1,78,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,221965},{0,71,12711},{1,71,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,221965},{0,78,12711},{1,78,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,444908},{0,69,1197830},{1,69,221965},{0,81,12711},{1,81,221965},{0,80,12711},{1,80,221965},{0,78,12711},{1,78,444908},{0,76,24445},{1,76,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,667851},{0,69,740210},{1,69,221965},{0,81,12711},{1,81,221965},{0,80,12711},{1,80,221965},{0,78,12711},{1,78,444908},{0,76,24445},{1,76,221965},{0,76,12711},{1,76,221965},{0,72,12711},{1,72,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,221965},{0,73,12711},{1,73,667851},{0,69,740210},{1,69,221965},{0,81,12711},{1,81,221965},{0,80,12711},{1,80,221965},{0,78,12711},{1,78,444908},{0,76,24445},{1,76,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,221965},{0,71,12711},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,667851},{0,69,270856},{1,69,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,71,12711},{1,71,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,963153},{1,69,221965},{0,76,12711},{1,76,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,71,12711},{1,71,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,444908},{0,64,0},{0,69,1197830},{1,64,0},{1,69,221965},{0,62,0},{0,69,12711},{1,62,0},{1,69,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,66,0},{0,69,24445},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,221965},{0,64,0},{0,71,12711},{1,64,0},{1,71,221965},{0,61,0},{0,73,12711},{1,61,0},{1,73,444908},{0,68,0},{0,71,24445},{1,68,0},{1,71,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,61,0},{0,69,24445},{1,61,0},{1,69,444908},{0,69,24445},{1,69,110493},{0,69,6844},{1,69,110493},{0,69,6844},{1,69,221965},{0,69,12711},{1,69,110493},{0,69,6844},{1,69,1002266},{0,69,288457},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,110493},{0,66,6844},{1,66,333436},{0,69,18578},{1,69,667851},{0,69,270856},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,110493},{0,66,0},{0,69,6844},{1,66,0},{1,69,110493},{0,64,0},{0,69,6844},{1,64,0},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,110493},{0,64,0},{0,69,6844},{1,64,0},{1,69,1002266},{0,66,0},{0,69,288457},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,110493},{0,62,0},{0,66,6844},{1,62,0},{1,66,333436},{0,61,0},{0,69,18578},{1,61,0},{1,69,667851},{0,64,0},{0,69,270856},{1,64,0},{1,69,221965},{0,62,0},{0,69,12711},{1,62,0},{1,69,221965},{0,61,0},{0,69,12711},{1,61,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,66,0},{0,69,24445},{1,66,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,66,0},{0,69,12711},{1,66,0},{1,69,221965},{0,64,0},{0,71,12711},{1,64,0},{1,71,221965},{0,61,0},{0,73,12711},{1,61,0},{1,73,444908},{0,68,0},{0,71,24445},{1,68,0},{1,71,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,221965},{0,64,0},{0,69,12711},{1,64,0},{1,69,444908},{0,61,0},{0,69,24445},{1,61,0},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,444908},{0,69,24445},{1,69,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,221965},{0,71,12711},{1,71,221965},{0,73,12711},{1,73,444908},{0,71,24445},{1,71,221965},{0,69,12711},{1,69,221965},{0,69,12711},{1,69,890794},{0,66,47913},{1,66,444908},{0,69,24445},{1,69,3566111},{2,0,0} };
/* 실행할 음악 데이터
 * # 주의 #
 * 파이썬 코드로 MIDI 파일을 변환했음. (midiPetal2.py)
 * 직접 수정하지 말 것.
 */

int song[] = {4,4,5,5,6,6,7,7,8,2,2,3};
 int m2p(int mid){
  /* m2p(음계)
   * MIDI 음계를 지점 음계에 맞는 포트로 옮겨준다
   */
  return song[mid % 12];
  }
 int freq(float key){
  /* freq(음계)
   * MIDI음계를 주파수로 바꿔준다
   */
  return pow(2,(key-49)/12)*440.0;
  }

int triWrite(int num){
  /* triWrite(색 번호)
   * "무지개색 총공격이다!!!"
   * 지정한 숫자에 맞는 스펙트럼의 색을 호출한다.
   */
  if(num<=255){
    analogWrite(11,255-num);
    analogWrite(12,num);
    }
  else{
    analogWrite(12,511-num);
    analogWrite(13,num-256);
    }
  }

void piano_on(int port,unsigned long time_delay){
  /* piano_on(음계,지연시간)
   * 지정한 음계에 맞는 포트를 지연시간동안 켠다.
   * 만약 지연시간이 0일 경우 다음 piano_on 실행 때 같이 켠다.
   */
    ports_enable[m2p(port)] = true;
  if(time_delay != 0){ 
    for(int j=0;j<256;j++){
      delayMicroseconds(time_delay/256);
    }
    for(int i=2;i<=9;i++) if(ports_enable[i]) digitalWrite(i,HIGH);
    //analogWrite((count % 3)+11,map(port,54,81,0,255));
    triWrite(map(port,54,81,0,511));
    tone(mport,freq(port));
    for(int i=2;i<=13;i++) ports_enable[i] = false;
    }
  }
void piano_off(int port,unsigned long time_delay){
  /* piano_off(음계,지연시간)
   * 지정한 음계에 맞는 포트를 지연시간동안 끈다.
   * 만약 지연시간이 0일 경우 다음 piano_off 실행 때 같이 끈다.
   */
    ports_disable[m2p(port)] = true;
  if(time_delay != 0){ 
    for(int j=255;j>=0;j--){
      delayMicroseconds(time_delay/256);
    }
    for(int i=2;i<=9;i++) if(ports_disable[i]) digitalWrite(i,LOW);
    for(int i=11;i<=13;i++)digitalWrite(i,LOW);
    
    noTone(mport);
    for(int i=2;i<=13;i++) ports_disable[i] = false;
    }
  }
    

void start_again(int unused1,unsigned long unused2){
  /* start_again(미사용,미사용)
   *  setup() 대신 사용하는 실제 초기화 코드
   * 재시작을 구현하기 위해 만들었음
   * 받는 변수(unused1,unused2)는 모두 사용하지 않음.
   */
    for(int i=2;i<=13;i++){
        pinMode(i,OUTPUT);
        digitalWrite(i,HIGH);
        delay(10);
        digitalWrite(i,LOW);
        }
    count=0;
    for(int i=0;i<=13;i++)ports_enable[i]=0;
    for(int i=0;i<=13;i++)ports_disable[i]=0;    
}




#define a_func func[notes[count].function_name]
#define a_port notes[count].port_num
#define a_time notes[count].length_in_float
/* a_func : musicdata 구조체의 실행할 함수
 * a_port : musicdata 함수가 쓸 포트
 * a_time : musicdata 함수가 줄 delay
 */

/****************************************************************************************************************************************/

void setup(){
    start_again(0,0);
    //초기화
}

void loop(){
  a_func(a_port,a_time);
  /* 지금 차례의 함수를 실행한다
   * 예시 :
   *  notes[count]
   *  => notes[30]
   *  => {1,4,400}
   *  => func[1](4,400);
   *  => piano_off(4,400);
   *  => 400μs에 걸쳐 4번 포트를 끈다.
   */
  count++;
  //다음 함수
  }

