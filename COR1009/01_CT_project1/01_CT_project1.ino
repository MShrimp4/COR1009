/*Project By 1조
 * 2018-04-10
 * 벚꽃 엔딩
 */

void piano_on(int port,unsigned long time_delay);
void piano_off(int port,unsigned long time_delay);
void start_again(int unused1,unsigned long unused2);

bool ports_enable[15]; // 켜진 포트 지정
bool ports_disable[15]; // 꺼진 포트 지정
int count; // 실행하는 음악 데이터 위치
void (*func[3])(int,unsigned long) = {piano_on,piano_off,start_again};
/* 실행할 함수들
 * func[0] : 건반 켜기
 * func[1] : 건반 끄기
 * func[2] : 다시 시작
 */

typedef struct{ // 음악을 담는 구조체
  byte function_name;
 /* 시킬 명령
  * 0 : 건반 켜기
  * 1 : 건반 끄기
  * 2 : 다시 시작
  */
  byte port_num;
  /* 켤 LED 포트
   * # 주의 #
   * 2번 (다시 시작) 은 이 변수를 사용하지 않음
   */
  unsigned long length_in_float;
  /* 실행할 시간
   * # 주의 #
   * 2번 (다시 시작) 은 이 변수를 사용하지 않음
   */
  } musicData;
musicData notes[1052]={ {1,2,0},{0,2,484033},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,6,1008},{1,6,483025},{0,4,1008},{1,4,1451093},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,1209076},{0,3,243025},{1,3,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,1693110},{0,8,1008},{1,8,241008},{0,6,1008},{1,6,1209076},{0,6,485042},{1,6,483025},{0,2,0},{0,4,1008},{1,2,0},{1,4,967059},{0,2,0},{0,4,243025},{1,2,0},{1,4,241008},{0,3,0},{0,5,1008},{1,3,0},{1,5,241008},{0,8,0},{0,4,1008},{1,8,0},{1,4,1209076},{0,6,0},{0,3,243025},{1,6,0},{1,3,241008},{0,6,0},{0,2,1008},{1,6,0},{1,2,241008},{0,8,0},{0,3,1008},{1,8,0},{1,3,1209076},{0,7,0},{0,8,243025},{1,7,0},{1,8,241008},{0,7,0},{0,2,1008},{1,7,0},{1,2,241008},{0,6,0},{0,6,1008},{1,6,0},{1,6,1209076},{0,4,1453110},{1,4,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,483025},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,483025},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,3,485042},{1,3,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,4,1453110},{1,4,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,2,727059},{1,2,483025},{0,2,1008},{1,2,725042},{0,7,243025},{1,7,241008},{0,7,0},{1,7,0},{0,7,1008},{1,7,241008},{0,2,0},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{1,2,0},{0,2,1008},{1,2,725042},{0,7,243025},{1,7,241008},{0,7,1008},{1,7,241008},{0,8,1008},{1,8,1209076},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,483025},{0,6,1008},{1,6,725042},{0,6,243025},{1,6,241008},{0,6,1008},{1,6,241008},{0,2,1008},{1,2,1209076},{0,7,485042},{1,7,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,483025},{0,2,1008},{1,2,483025},{0,7,1008},{1,7,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,1209076},{0,3,485042},{1,3,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,2,1211093},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1451093},{0,2,243025},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,967059},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,725042},{0,4,969076},{1,4,1451093},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,1209076},{0,3,243025},{1,3,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,1693110},{0,8,1008},{1,8,241008},{0,6,1008},{1,6,1209076},{0,6,485042},{1,6,483025},{0,2,0},{0,4,1008},{1,2,0},{1,4,967059},{0,2,0},{0,4,243025},{1,2,0},{1,4,241008},{0,3,0},{0,5,1008},{1,3,0},{1,5,241008},{0,8,0},{0,4,1008},{1,8,0},{1,4,1209076},{0,6,0},{0,3,243025},{1,6,0},{1,3,241008},{0,6,0},{0,2,1008},{1,6,0},{1,2,241008},{0,8,0},{0,3,1008},{1,8,0},{1,3,1209076},{0,7,0},{0,8,243025},{1,7,0},{1,8,241008},{0,7,0},{0,2,1008},{1,7,0},{1,2,241008},{0,6,0},{0,6,1008},{1,6,0},{1,6,1209076},{0,4,1453110},{1,4,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,483025},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,483025},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,3,485042},{1,3,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,4,1453110},{1,4,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,483025},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,2,727059},{1,2,483025},{0,2,1008},{1,2,725042},{0,7,243025},{1,7,241008},{0,7,0},{1,7,0},{0,7,1008},{1,7,241008},{0,2,0},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{1,2,0},{0,2,1008},{1,2,725042},{0,7,243025},{1,7,241008},{0,7,1008},{1,7,241008},{0,8,1008},{1,8,1209076},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,483025},{0,6,1008},{1,6,725042},{0,6,243025},{1,6,241008},{0,6,1008},{1,6,241008},{0,2,1008},{1,2,1209076},{0,7,485042},{1,7,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,483025},{0,2,1008},{1,2,483025},{0,7,1008},{1,7,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,1209076},{0,3,485042},{1,3,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,483025},{0,2,1211093},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1451093},{0,2,243025},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,967059},{0,4,1453110},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1209076},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1209076},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,967059},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,2,1008},{1,2,241008},{0,7,1008},{1,7,120000},{0,3,1008},{1,3,120000},{0,3,1008},{1,3,725042},{0,4,485042},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1209076},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,725042},{0,6,243025},{1,6,241008},{0,6,1008},{1,6,241008},{0,6,1008},{1,6,241008},{0,6,1008},{1,6,241008},{0,7,1008},{1,7,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,1209076},{0,4,243025},{1,4,725042},{0,4,1008},{1,4,967059},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1209076},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,967059},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,2,1008},{1,2,241008},{0,7,1008},{1,7,120000},{0,3,1008},{1,3,120000},{0,3,1008},{1,3,725042},{0,4,485042},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1209076},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,725042},{0,4,243025},{1,4,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,7,1008},{1,7,241008},{0,7,1008},{1,7,241008},{0,6,1008},{1,6,241008},{0,7,1008},{1,7,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,1209076},{0,2,1453110},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,483025},{0,3,485042},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,485042},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,6,1008},{1,6,241008},{0,4,1008},{1,4,483025},{0,4,485042},{1,4,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,485042},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,5,1008},{1,5,241008},{0,4,1008},{1,4,241008},{0,5,1008},{1,5,483025},{0,5,1008},{1,5,241008},{0,6,1008},{1,6,241008},{0,6,1008},{1,6,1451093},{0,2,243025},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,1451093},{0,2,243025},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,483025},{0,2,1008},{1,2,1451093},{0,8,243025},{1,8,483025},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,8,1008},{1,8,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,8,1008},{1,8,1693110},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,2,1008},{1,2,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,7,1008},{1,7,1693110},{0,7,1008},{1,7,120000},{0,7,1008},{1,7,120000},{0,6,1008},{1,6,725042},{0,6,485042},{1,6,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,241008},{0,4,1008},{1,4,241008},{0,4,1008},{1,4,967059},{0,2,243025},{1,2,483025},{0,2,1008},{1,2,725042},{0,2,1453110},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{0,2,485042},{1,2,241008},{0,3,1008},{1,3,241008},{0,3,1008},{1,3,483025},{2,0,0} };
/* 실행할 음악 데이터
 * # 주의 #
 * 파이썬 코드로 MIDI 파일을 변환했음. (midiPetal2.py)
 * 직접 수정하지 말 것.
 */

void piano_on(int port,unsigned long time_delay){
  /* piano_on(포트,지연시간)
   * 지정한 포트를 지연시간동안 켠다.
   * 만약 지연시간이 0일 경우 다음 piano_on 실행 때 같이 켠다.
   */
    ports_enable[port] = true;
  if(time_delay != 0){ 
    for(int j=0;j<256;j++){
      for(int i=2;i<=9;i++) if(ports_enable[i]) analogWrite(i,j);
      delayMicroseconds(time_delay/256);
    }
    for(int i=2;i<=13;i++) ports_enable[i] = false;
    }
  }
void piano_off(int port,unsigned long time_delay){
  /* piano_off(포트,지연시간)
   * 지정한 포트를 지연시간동안 끈다.
   * 만약 지연시간이 0일 경우 다음 piano_off 실행 때 같이 끈다.
   */
    ports_disable[port] = true;
  if(time_delay != 0){ 
    for(int j=255;j>=0;j--){
      for(int i=2;i<=9;i++) if(ports_disable[i]) analogWrite(i,j);
      delayMicroseconds(time_delay/256);
    }
    for(int i=2;i<=13;i++) ports_disable[i] = false;
    }
  }
    

void start_again(int unused1,unsigned long unused2){
  /* start_again(미사용,미사용)
   *  setup() 대신 사용하는 실제 초기화 코드
   * 재시작을 구현하기 위해 만들었음
   * 받는 변수(unused1,unused2)는 모두 사용하지 않음.
   */
    for(int i=2;i<=13;i++){
        pinMode(i,OUTPUT);
        digitalWrite(i,HIGH);
        delay(300);
        digitalWrite(i,LOW);
        }
    count=0;
    for(int i=0;i<=13;i++)ports_enable[i]=0;
    for(int i=0;i<=13;i++)ports_disable[i]=0;    
}




#define a_func func[notes[count].function_name]
#define a_port notes[count].port_num
#define a_time notes[count].length_in_float
/* a_func : musicdata 구조체의 실행할 함수
 * a_port : musicdata 함수가 쓸 포트
 * a_time : musicdata 함수가 줄 delay
 */

/****************************************************************************************************************************************/

void setup(){
    start_again(0,0);
    //초기화
}

void loop(){
  a_func(a_port,a_time);
  /* 지금 차례의 함수를 실행한다
   * 예시 :
   *  notes[count]
   *  => notes[30]
   *  => {1,4,400}
   *  => func[1](4,400);
   *  => piano_off(4,400);
   *  => 400μs에 걸쳐 4번 포트를 끈다.
   */
  count++;
  //다음 함수
  }

